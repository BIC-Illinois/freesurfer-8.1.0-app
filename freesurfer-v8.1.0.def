Bootstrap: docker
From: vnmd/freesurfer:8.0.0

# Copy FreeSurfer license
%files
./license.txt /usr/local/freesurfer/8.1.0/.license
./recon-all-clinical.sh /usr/local/freesurfer/8.1.0/recon-all-clinical.sh

%post 
# To support (hippocampus and) amygdala subnuclei segmentation
# cd $FREESURFER_HOME/bin && curl https://raw.githubusercontent.com/freesurfer/freesurfer/dev/scripts/fs_install_mcr -o fs_install_mcr && chmod +x fs_install_mcr
# fs_install_mcr R2019b
# To support hypothalamic subunits segmentation
# apt-get install python3-pip && pip3 install -U tensorflow-cpu

cd /opt && curl https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/8.1.0/freesurfer_ubuntu22-8.1.0_amd64.deb -o freesurfer_ubuntu22-8.1.0_amd64.deb && apt-get install -y ./freesurfer_ubuntu22-8.1.0_amd64.deb

# Install  libGLU.so.1
apt-get update && apt-get install -y libglu1-mesa libgl1-mesa-dev

# Install ImageMagick convert and dependencies
apt-get install -y build-essential \
    bzip2 libfreetype6-dev libjpeg-dev libpng-dev libtiff-dev zlib1g-dev \
    libtool libx11-dev libxext-dev libxt-dev libxml2-dev librsvg2-dev \
    php-dev

mkdir /opt/ImageMagick && cd /opt/ImageMagick && wget https://www.imagemagick.org/download/ImageMagick.tar.gz && tar -xvzf ImageMagick.tar.gz && cd ImageMagick-7.1.2-3 && ./configure && make && make install

apt-get install -y xvfb

# Add Freesurfer setup to .bashrc
echo "export FREESURFER_HOME=/usr/local/freesurfer/8.1.0" >> /etc/bash.bashrc
echo "export PATH=$FREESURFER_HOME/bin:$PATH" >> /etc/bash.bashrc
echo "export SUBJECTS_DIR=$FREESURFER_HOME/subjects" >> /etc/bash.bashrc
echo "export FS_LICENSE_FILE=$FREESURFER_HOME/.license" >> /etc/bash.bashrc
echo "source $FREESURFER_HOME/SetUpFreeSurfer.sh" >> /etc/bash.bashrc

%environment
# Set environment variables for Freesurfer
export FREESURFER_HOME=/usr/local/freesurfer/8.1.0
export PATH=$FREESURFER_HOME/bin:$PATH
export SUBJECTS_DIR=$FREESURFER_HOME/subjects
export FS_LICENSE=$FREESURFER_HOME/.license
export FS_LICENSE_FILE=$FREESURFER_HOME/.license
export SUBJECTS_DIR="$FREESURFER_HOME/subjects"
export FSF_OUTPUT_FORMAT="nii.gz"
export MNI_DIR="$FREESURFER_HOME/mni"
export LOCAL_DIR="$FREESURFER_HOME/local"
export FREESURFER_HOME="$FREESURFER_HOME"
export FSFAST_HOME="$FREESURFER_HOME/fsfast"
export MINC_BIN_DIR="$FREESURFER_HOME/mni/bin"
export MINC_LIB_DIR="$FREESURFER_HOME/mni/lib"
export MNI_DATAPATH="$FREESURFER_HOME/mni/data"
export FMRI_ANALYSIS_DIR="$FREESURFER_HOME/fsfast"
export PERL5LIB="$FREESURFER_HOME/mni/share/perl5"
export MNI_PERL5LIB="$FREESURFER_HOME/mni/share/perl5/"
export PATH="$PATH:$FREESURFER_HOME/bin:$FREESURFER_HOME/fsfast/bin:$FREESURFER_HOME/tktools:$FREESURFER_HOME/mni/bin"

%runscript
bash -c "source $FREESURFER_HOME/SetUpFreeSurfer.sh &&  ${@}"
