Bootstrap: docker
From: vnmd/freesurfer:8.0.0

# Copy FreeSurfer license
%files
./license.txt /opt/freesurfer-8.0.0/.license

%post 
# To support (hippocampus and) amygdala subnuclei segmentation
# cd $FREESURFER_HOME/bin && curl https://raw.githubusercontent.com/freesurfer/freesurfer/dev/scripts/fs_install_mcr -o fs_install_mcr && chmod +x fs_install_mcr
# fs_install_mcr R2019b
# To support hypothalamic subunits segmentation
# apt-get install python3-pip && pip3 install -U tensorflow-cpu

cd /opt && curl https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/8.1.0/freesurfer_ubuntu22-8.1.0_amd64.deb -o freesurfer_ubuntu22-8.1.0_amd64.deb && apt-get install -y ./freesurfer_ubuntu22-8.1.0_amd64.deb

# Install  libGLU.so.1
apt-get update && apt-get install -y libglu1-mesa libgl1-mesa-dev

# Install ImageMagick convert and dependencies
apt-get install -y build-essential \
    bzip2 libfreetype6-dev libjpeg-dev libpng-dev libtiff-dev zlib1g-dev \
    libtool libx11-dev libxext-dev libxt-dev libxml2-dev librsvg2-dev \
    php-dev

mkdir /opt/ImageMagick && cd /opt/ImageMagick && wget https://www.imagemagick.org/download/ImageMagick.tar.gz && tar -xvzf ImageMagick.tar.gz && cd ImageMagick-7.1.2-3 && ./configure && make && make install

apt-get install -y xvfb

# Add Freesurfer setup to .bashrc
echo "export FREESURFER_HOME=/usr/local/freesurfer/8.1.0" >> /etc/bash.bashrc
echo "export PATH=$FREESURFER_HOME/bin:$PATH" >> /etc/bash.bashrc
echo "export SUBJECTS_DIR=$FREESURFER_HOME/subjects" >> /etc/bash.bashrc
echo "export FS_LICENSE_FILE=$FREESURFER_HOME/.license" >> /etc/bash.bashrc
echo "source $FREESURFER_HOME/SetUpFreeSurfer.sh" >> /etc/bash.bashrc
